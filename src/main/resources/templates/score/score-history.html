<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <link rel="stylesheet" href="/css/score-history-style.css">
  <meta charset="UTF-8">
  <title>スコア履歴</title>
</head>
<body>
<div class="ranking-container">
  <div class="header">
    <h1  th:text="'「' + ${username} + '」の戦歴'" class="page-title" >「user」の戦歴</h1>
  </div>

  <div class="content">
    <select id="sortSelect">
      <option value="created_at">日付順</option>
      <option value="score">得点順</option>
    </select>
    <div class="tab-content">
      <div class="ranking-table">
        <div class="table-header">
          <div class="header-cell">順位</div>
          <div class="header-cell">得点</div>
          <div class="header-cell">記録日</div>
        </div>
        <div id="history-table-body"></div>
      </div>
    </div>
  </div>
  <!-- ページネーション -->
  <div class="pagination" id="pagination"></div>
</div>

<div class="buttons">
  <button id="back-to-top">↑</button>
  <a th:href="@{/quiz}" id="back-top">トップに戻る</a>
</div>

<!-- ThymeleafでJSにデータを埋め込む -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const historyData = /*[[${history}]]*/ [];
  /*]]>*/
</script>

<script>

  //検索
  document.getElementById("sortSelect").addEventListener("change", function () {
    const sort = this.value;

    fetch(`/score/history/sort?sort=${sort}`)
            .then(response => response.json())  // ← JSONで受け取る
            .then(newHistoryData => {
              historyData.length = 0;
              historyData.push(...newHistoryData);

              currentPage = 1;
              renderTable(currentPage);
              renderPagination();
            })
            .catch(error => console.error("Error:", error));
  });





  //↑が押されたとき
  document.getElementById("back-to-top").addEventListener("click", () => {
    window.scrollTo({
      top: 0,
      behavior: "smooth" // 滑らかにスクロール
    });
  });



  //ページネーション

  const tableBody = document.getElementById("history-table-body");
  const paginationDiv = document.getElementById("pagination");

  const rowsPerPage = 15;
  let currentPage = 1;
  const totalPages = Math.ceil(historyData.length / rowsPerPage);
  const maxviewpage = 8;

  function renderTable(page) {
    tableBody.innerHTML = "";
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = historyData.slice(start, end);

    for (const item of pageData) {
        const div = document.createElement("div");
        div.classList.add("ranking-row");
        div.innerHTML = `
      <div class="cell rank-cell">${item.rank}</div>
      <div class="cell score-cell">${item.score}</div>
      <div class="cell date-cell">${item.createdAt}</div>`;
      tableBody.append(div);
    }
    if (historyData && historyData.length === 0){
      const div = document.createElement("div");
      div.classList.add("ranking-row");

      div.innerHTML = `
　　　 <div class="cell score-cell">戦歴がありません</div>
      `;
      tableBody.append(div);
    }
  }

  function renderPagination() {
    paginationDiv.innerHTML = "";
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "前へ";
    prevBtn.disabled = currentPage === 1;
    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderTable(currentPage);
        renderPagination();
      }
    });
    paginationDiv.appendChild(prevBtn);

    const half = Math.floor(maxviewpage / 2);
    let startPage = currentPage;
    let endPage = startPage + maxviewpage - 1;

    if (endPage > totalPages) {
      endPage = totalPages;
      startPage = Math.max(1, endPage - maxviewpage + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = i;
        renderTable(currentPage);
        renderPagination();
      });
      paginationDiv.appendChild(btn);
    }

    if (endPage < totalPages) {
      const dots = document.createElement("span");
      dots.textContent = "...";
      paginationDiv.appendChild(dots);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "次へ";
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.addEventListener("click", () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTable(currentPage);
        renderPagination();
      }
    });
    paginationDiv.appendChild(nextBtn);
  }

  renderTable(currentPage);
  renderPagination();
</script>
</body>
</html>
