<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/quiz-result.css">
    <title>結果</title>
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<body>
    <section>
        <div class="quiz-result">

            <p class="title">結果</p>

            <div class="result-details">
                <div class="answer-count">
                    <p class="sub-title">正答数</p>
                    <p class="ans-result" th:text="${correctCount} + '/10'"></p>
                </div>
                <div class="score">
                    <p class="sub-title">得点</p>
                    <p class="score-result" th:text="${score} + '点'">1600点</p>
                </div>
                <div class="time">
                    <p class="sub-title">解答時間</p>
                    <p class="time-result" th:text="${time} + '秒'">50秒</p>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="quiz-details">
            <p class="title">正誤・解説</p>
            <div class="quiz" th:each="detail : ${quizDetails}">
                <details>
                    <summary>
                        <span class="question" th:text="'第' + ${detail.quizNumber} + '問'">第1問</span>
                        <span class="correct" th:if="${detail.result}">✓正解</span>
                        <span class="wrong" th:unless="${detail.result}">×不正解</span>
                    </summary>
                    <div class="content">
                        <div class="correct-or-wrong">
                            <div class="your-answer">
                                <p class="ans-title">あなたの解答</p>
                                <span class="answer" th:each="item,stat : ${detail.answers}">
                                    <span th:text="${item}"></span>
                                    <span th:if="${!stat.last}">→</span>
                                </span>
                            </div>
                            <div class="true-answer">
                                <p class="ans-title">正答</p>
                                <span class="answer" th:each="item,stat : ${detail.corrects}">
                                    <span th:text="${item}"></span>
                                    <span th:if="${!stat.last}">→</span>
                                </span>
                            </div>
                        </div>


                        <p class="exp-title">解説</p>

                        <div class="explanation">
                            <div class="exp-detail" th:each="item : ${detail.quizDetails}">
                                <h3 th:text="|${item.content}(${item.happenYear}年)|"></h3>
                                <p th:text="${item.description}"></p>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </div>
    </section>

    <div class="buttons">
        <button id="back-to-top">↑</button>
        <a th:href="@{/quiz}" id="back-top">トップに戻る</a>
    </div>

    <div id="toast_title" class="toast">操作が完了しました</div>

    <script>
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content")
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content")
        //↑が押されたとき
        document.getElementById("back-to-top").addEventListener("click", () => {
            window.scrollTo({
                top: 0,
                behavior: "smooth" // 滑らかにスクロール
            });
        });

    //     称号獲得
        const toastTitle = document.querySelector("#toast_title")
        async function getAchieveTitles() {
            await fetch("api/achieveTitle", {
                method: 'GET',
                headers: {
                    [csrfHeader]: csrfToken,
                    'Content-Type': 'application/json',
                },
            })
                .then(res => res.json())
                .then(result => {
                    if (result.achievedTitles.length >= 1) {
                        result.achievedTitles.forEach(item => {
                            console.log('toast')
                            const toast = document.createElement('div')
                            toast.className = 'toast show'
                            toast.innerHTML = `
                            <div>${item.title}:${item.description}</div>
                            `
                            toastTitle.appendChild(toast)
                            setTimeout(() => {
                                toast.remove()
                            }, 3000)
                        })
                    }
                })
        }
        getAchieveTitles()
    </script>
</body>
</html>